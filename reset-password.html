<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KXON ‚Äî Nueva Contrase√±a</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Montserrat:wght@400;500;600;700;800;900&family=Oswald:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
<meta name="theme-color" content="#0a0a0a">
    <style>
        :root{--negro-base:#0a0a0a;--negro-card:#0f0f0f;--negro-suave:#111;--negro-medio:#1a1a1a;--negro-hover:#2a2a2a;--plata-oscura:#555;--plata-media:#888;--plata-normal:#a0a0a0;--plata-clara:#b8b8b8;--plata-titulo:#e0e0e0;--plata-blanca:#f0f0f0;--acento-principal:#c0c0c0;--acento-error:#ff4757;--acento-exito:#2ed573;--font-titulo:'Montserrat',sans-serif;--font-cuerpo:'Inter',sans-serif;--font-logo:'Oswald',sans-serif;--trans-normal:all .3s ease;--trans-suave:all .3s cubic-bezier(.4,0,.2,1);--radio-sm:8px;--radio-md:12px}
        *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
        html{font-size:16px;-webkit-font-smoothing:antialiased}
        body{font-family:var(--font-cuerpo);color:var(--plata-clara);background:var(--negro-base);min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;position:relative}
        a{text-decoration:none;color:var(--plata-clara);transition:var(--trans-normal)}a:hover{color:var(--plata-blanca)}
        ::selection{background:rgba(192,192,192,.2);color:var(--plata-blanca)}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
        @keyframes glow{0%,100%{box-shadow:0 0 5px rgba(192,192,192,.1)}50%{box-shadow:0 0 20px rgba(192,192,192,.15)}}
        @keyframes spin{to{transform:rotate(360deg)}}
        .bg-decoration{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0}
        .bg-circle{position:absolute;border-radius:50%;border:1px solid rgba(192,192,192,.03)}
        .bg-circle-1{width:600px;height:600px;top:-200px;right:-200px}
        .bg-circle-2{width:400px;height:400px;bottom:-100px;left:-100px}
        .bg-glow{position:absolute;width:300px;height:300px;border-radius:50%;filter:blur(100px);opacity:.03;background:var(--acento-principal)}
        .bg-glow-1{top:20%;right:20%}.bg-glow-2{bottom:20%;left:20%}
        .bg-grid{position:absolute;top:0;left:0;right:0;bottom:0;background-image:linear-gradient(rgba(192,192,192,.02) 1px,transparent 1px),linear-gradient(90deg,rgba(192,192,192,.02) 1px,transparent 1px);background-size:60px 60px}
        .auth-wrapper{position:relative;z-index:1;width:100%;max-width:440px;padding:20px;animation:fadeIn .8s ease}
        .auth-card{background:rgba(15,15,15,.8);backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);border:1px solid rgba(255,255,255,.06);border-radius:var(--radio-md);padding:48px 40px;position:relative;overflow:hidden}
        .auth-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(192,192,192,.2),transparent)}
        .auth-logo{text-align:center;margin-bottom:40px}
        .auth-logo a{display:inline-flex;align-items:center;gap:3px}
        .auth-logo-text{font-family:var(--font-logo);font-size:2.2rem;font-weight:700;letter-spacing:8px;text-transform:uppercase}
        .auth-logo-text span{background:linear-gradient(135deg,#e0e0e0 0%,#888 50%,#e0e0e0 100%);background-size:200% auto;-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:shimmer 3s linear infinite}
        .auth-logo-dot{width:8px;height:8px;background:var(--acento-principal);border-radius:50%;animation:glow 2s ease-in-out infinite;box-shadow:0 0 10px rgba(192,192,192,.4)}
        .auth-title{text-align:center;font-family:var(--font-titulo);font-size:1.3rem;font-weight:700;color:var(--plata-titulo);margin-bottom:8px}
        .auth-subtitle{text-align:center;font-size:.85rem;color:var(--plata-media);font-weight:300;margin-bottom:36px}
        .auth-form{display:flex;flex-direction:column;gap:20px}
        .form-group{display:flex;flex-direction:column;gap:8px}
        .form-label{font-size:.75rem;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--plata-media);font-family:var(--font-titulo)}
        .form-input{width:100%;padding:14px 18px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:var(--radio-sm);color:var(--plata-blanca);font-family:var(--font-cuerpo);font-size:.92rem;transition:var(--trans-suave);outline:none}
        .form-input::placeholder{color:var(--plata-oscura);font-weight:300}
        .form-input:focus{border-color:rgba(192,192,192,.3);background:rgba(255,255,255,.05);box-shadow:0 0 0 3px rgba(192,192,192,.05)}
        .password-wrapper{position:relative}
        .password-toggle{position:absolute;right:16px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--plata-oscura);cursor:pointer;font-size:.85rem;padding:4px;transition:var(--trans-normal)}
        .password-toggle:hover{color:var(--plata-clara)}
        .btn-submit{width:100%;padding:15px;background:linear-gradient(135deg,#2a2a2a 0%,#1a1a1a 100%);color:var(--plata-blanca);border:1px solid rgba(192,192,192,.2);border-radius:var(--radio-sm);font-family:var(--font-titulo);font-weight:700;font-size:.82rem;letter-spacing:2px;text-transform:uppercase;cursor:pointer;transition:var(--trans-suave);position:relative;overflow:hidden;margin-top:8px}
        .btn-submit::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);transition:all .5s ease}
        .btn-submit:hover::before{left:100%}
        .btn-submit:hover{background:linear-gradient(135deg,#c0c0c0 0%,#888 100%);color:var(--negro-base);border-color:var(--acento-principal);box-shadow:0 0 30px rgba(192,192,192,.12);transform:translateY(-2px)}
        .btn-submit:disabled{opacity:.5;cursor:not-allowed;transform:none}
        .btn-submit.loading{color:transparent;pointer-events:none}
        .btn-submit.loading::after{content:'';position:absolute;top:50%;left:50%;width:20px;height:20px;margin:-10px 0 0 -10px;border:2px solid rgba(192,192,192,.3);border-top-color:var(--plata-blanca);border-radius:50%;animation:spin .6s linear infinite}
        .auth-message{padding:12px 16px;border-radius:var(--radio-sm);font-size:.82rem;font-weight:500;text-align:center;display:none;animation:fadeIn .3s ease;margin-bottom:12px;word-break:break-word}
        .auth-message.show{display:block}
        .auth-message.error{background:rgba(255,71,87,.1);color:var(--acento-error);border:1px solid rgba(255,71,87,.2)}
        .auth-message.success{background:rgba(46,213,115,.1);color:var(--acento-exito);border:1px solid rgba(46,213,115,.2)}
        .success-icon{font-size:3rem;text-align:center;margin-bottom:16px;animation:fadeIn .5s ease}
        @media(max-width:480px){.auth-wrapper{padding:16px}.auth-card{padding:36px 24px}.auth-logo-text{font-size:1.8rem;letter-spacing:6px}}
    </style>
</head>
<body>
    <div class="bg-decoration">
        <div class="bg-grid"></div>
        <div class="bg-circle bg-circle-1"></div>
        <div class="bg-circle bg-circle-2"></div>
        <div class="bg-glow bg-glow-1"></div>
        <div class="bg-glow bg-glow-2"></div>
    </div>
    <div class="auth-wrapper">
        <div class="auth-card">
            <div class="auth-logo"><a href="index.html"><span class="auth-logo-text"><span>KXON</span></span><span class="auth-logo-dot"></span></a></div>

            <!-- ESTADO 1: FORMULARIO NUEVA CONTRASE√ëA -->
            <div id="resetView">
                <h1 class="auth-title">Nueva Contrase√±a</h1>
                <p class="auth-subtitle">Ingresa tu nueva contrase√±a</p>
                <div class="auth-message" id="authMessage"></div>
                <form class="auth-form" id="resetForm" novalidate>
                    <div class="form-group">
                        <label class="form-label" for="newPassword">Nueva contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="newPassword" class="form-input" placeholder="M√≠nimo 6 caracteres">
                            <button type="button" class="password-toggle" onclick="togglePass('newPassword',this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirmar contrase√±a</label>
                        <div class="password-wrapper">
                            <input type="password" id="confirmPassword" class="form-input" placeholder="Repite la contrase√±a">
                            <button type="button" class="password-toggle" onclick="togglePass('confirmPassword',this)">üëÅÔ∏è</button>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit" id="btnSubmit">Cambiar Contrase√±a</button>
                </form>
            </div>

            <!-- ESTADO 2: √âXITO -->
            <div id="successView" style="display:none;">
                <div class="success-icon">‚úÖ</div>
                <h1 class="auth-title">¬°Contrase√±a Actualizada!</h1>
                <p class="auth-subtitle">Tu contrase√±a ha sido cambiada exitosamente. Ya puedes iniciar sesi√≥n.</p>
                <a href="login.html" class="btn-submit" style="display:flex;align-items:center;justify-content:center;margin-top:20px;text-decoration:none;">Ir al Login</a>
            </div>

            <!-- ESTADO 3: ERROR DE TOKEN -->
            <div id="errorView" style="display:none;">
                <div class="success-icon">‚ö†Ô∏è</div>
                <h1 class="auth-title">Enlace Inv√°lido</h1>
                <p class="auth-subtitle">Este enlace ha expirado o es inv√°lido. Solicita uno nuevo.</p>
                <a href="forgot-password.html" class="btn-submit" style="display:flex;align-items:center;justify-content:center;margin-top:20px;text-decoration:none;">Solicitar Nuevo Enlace</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    function togglePass(id, btn) {
        var p = document.getElementById(id);
        if (p.type === 'password') { p.type = 'text'; btn.textContent = 'üôà'; }
        else { p.type = 'password'; btn.textContent = 'üëÅÔ∏è'; }
    }

    (function(){
        var db = window.supabase.createClient(
            'https://zizbbypwwvugyswjfbxr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InppemJieXB3d3Z1Z3lzd2pmYnhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA1OTkyMTQsImV4cCI6MjA4NjE3NTIxNH0.PwTvjIyPkfbnFMFB9k9XPHDxYrKBkkPIslQJ5UcY_9U'
        );

        var form = document.getElementById('resetForm');
        var btnSubmit = document.getElementById('btnSubmit');
        var authMsg = document.getElementById('authMessage');

        function showMsg(t, type) {
            authMsg.textContent = t;
            authMsg.className = 'auth-message show ' + type;
        }

        /* Verificar que hay sesi√≥n de recovery */
        (async function() {
            var hashParams = new URLSearchParams(window.location.hash.substring(1));
            var type = hashParams.get('type');
            var accessToken = hashParams.get('access_token');

            if (type === 'recovery' && accessToken) {
                /* Supabase maneja autom√°ticamente el token desde la URL */
                try {
                    var r = await db.auth.getSession();
                    if (!r.data.session) {
                        /* Intentar setear la sesi√≥n con el token */
                        await db.auth.setSession({
                            access_token: accessToken,
                            refresh_token: hashParams.get('refresh_token') || ''
                        });
                    }
                } catch(e) {
                    console.error(e);
                }
            } else {
                /* Verificar si Supabase ya proces√≥ el token autom√°ticamente */
                try {
                    var session = await db.auth.getSession();
                    if (!session.data.session) {
                        document.getElementById('resetView').style.display = 'none';
                        document.getElementById('errorView').style.display = 'block';
                    }
                } catch(e) {
                    document.getElementById('resetView').style.display = 'none';
                    document.getElementById('errorView').style.display = 'block';
                }
            }
        })();

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            var newPass = document.getElementById('newPassword').value;
            var confirmPass = document.getElementById('confirmPassword').value;

            if (!newPass || newPass.length < 6) {
                showMsg('La contrase√±a debe tener m√≠nimo 6 caracteres', 'error');
                return;
            }
            if (newPass !== confirmPass) {
                showMsg('Las contrase√±as no coinciden', 'error');
                return;
            }

            btnSubmit.classList.add('loading');
            btnSubmit.disabled = true;

            try {
                var r = await db.auth.updateUser({ password: newPass });
                if (r.error) throw r.error;

                document.getElementById('resetView').style.display = 'none';
                document.getElementById('successView').style.display = 'block';

                await db.auth.signOut();
            } catch (e) {
                var msg = 'Error al cambiar contrase√±a';
                if (e.message.indexOf('same') >= 0) msg = 'Debe ser diferente a la actual';
                else if (e.message.indexOf('weak') >= 0) msg = 'Contrase√±a muy d√©bil';
                else if (e.message.indexOf('session') >= 0) msg = 'Enlace expirado, solicita uno nuevo';
                showMsg(msg, 'error');
                btnSubmit.classList.remove('loading');
                btnSubmit.disabled = false;
            }
        });
    })();
    </script>
</body>
</html>